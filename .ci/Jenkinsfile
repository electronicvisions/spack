#!/usr/bin/env groovy

node {
    LIVE_INSTANCE="/wang/environment/software/jessie/spack/${GERRIT_BRANCH}_live"
    STAGE_INSTANCE="/wang/environment/software/jessie/spack/${GERRIT_BRANCH}_staging"

    if (GERRIT_EVENT_TYPE=="change-merged") {
        WORKING_DIR=LIVE_INSTANCE
    } else {
        WORKING_DIR=STAGE_INSTANCE
    }

    print WORKING_DIR

    if (${GERRIT_EVENT_TYPE}!="change-merged") {
        stage('stack') {
            sh "echo ${WORKING_DIR} && " +
                "cd ${WORKING_DIR} &&" +
                ". share/spack/setup-env.sh && " +
                "spack stack ${LIVE_INSTANCE}"
        }
    }

    stage('compiler') {
        sh '''
        cd ${WORKING_DIR}
        set +x
        . share/spack/setup-env.sh
        set -x
        bash -x .ci/01_ensure_gcc.sh
        '''
    }

    stage('dlspy2') {
        sh '''
        cd "/wang/environment/software/jessie/spack/${GERRIT_REFSPEC}_staging"
        set +x
        . share/spack/setup-env.sh
        set -x
        bash -x .ci/02_install.sh dls_py2 \'visionary-defaults-dls ^python@2.7.14 %gcc@7.2.0\' \'gcc@7.2.0 %gcc@7.2.0\'
        '''
    }

    stage('dlspy3') {
        sh '''
        cd "/wang/environment/software/jessie/spack/${GERRIT_REFSPEC}_staging"
        set +x
        . share/spack/setup-env.sh
        set -x
        .ci/02_install.sh dls_py3 \'visionary-defaults-dls ^python@3.6.3 %gcc@7.2.0\' \'gcc@7.2.0 %gcc@7.2.0\'
        '''
    }
}
